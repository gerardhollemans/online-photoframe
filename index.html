<!DOCTYPE html>
<html>
<head>
  <title>Google Drive Photo Slideshow</title>
  <meta charset="utf-8">
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    #authorize-button, #folder-picker-button {
      margin: 10px 0;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    #fullscreen-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,1);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #fullscreen-image {
      max-width: 100vw;
      max-height: 100vh;
      object-fit: contain;
      cursor: zoom-out;
    }
  </style>
</head>
<body>
  <h1>Google Drive Folder Photo Slideshow</h1>
  
  <button id="authorize-button" style="display: none;">Sign in with Google</button>
  <button id="signout-button" style="display: none;">Sign out</button>
  <button id="folder-picker-button" style="display: none;">Select folder</button>
  
  <div id="info"></div>

  <!-- Slideshow lives here in normal mode -->
  <div id="image-container">
    <img id="normal-image" style="max-width: 200px; cursor: pointer; display: block;">
  </div>

  <!-- Fullscreen overlay lives here -->
  <div id="fullscreen-overlay" style="display: none;">
    <img id="fullscreen-image">
  </div>

  <script type="text/javascript">
    // Replace with your own Client ID from Google Cloud Console
    const CLIENT_ID = '776150985676-43dmquafuliuobhkg4v73v9nj8m4n459.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyDi69wPOMCgBqFy939Um1ZDHsmHdFLcGrY';
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
    const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;
    let accessToken = null;
    let pickerInited = false;

    let files = [];
    let currentIndex = 0;
    let fullscreen = false;
    let slideshowTimer;
    let isSlideshowActive = false;

    function gapiLoaded() {
      gapi.load('client:picker', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: [DISCOVERY_DOC],
      });
      gapiInited = true;
      maybeEnableButtons();
    }

    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '', // defined later
      });
      gisInited = true;
      maybeEnableButtons();
    }

    function maybeEnableButtons() {
      if (gapiInited && gisInited) {
        document.getElementById('authorize-button').style.display = 'block';
      }
    }

    function handleAuthClick() {
      tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
          throw (resp);
        }
        accessToken = gapi.client.getToken().access_token;
        document.getElementById('signout-button').style.display = 'block';
        document.getElementById('authorize-button').style.display = 'none';
        document.getElementById('folder-picker-button').style.display = 'block';
      };

      if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
      } else {
        tokenClient.requestAccessToken({prompt: ''});
      }
    }

    function handleSignoutClick() {
      endSlideshow();
      clearAccessToken();

      document.getElementById('info').innerText = '';
      document.getElementById('authorize-button').style.display = 'block';
      document.getElementById('signout-button').style.display = 'none';
      document.getElementById('folder-picker-button').style.display = 'none';
    }

    function clearAccessToken() {
      const token = gapi.client.getToken();
      if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken('');
        accessToken = null;
      }
    }

    function createPicker() {
      const view = new google.picker.DocsView(google.picker.ViewId.FOLDERS)
          .setSelectFolderEnabled(true);

      const picker = new google.picker.PickerBuilder()
          .enableFeature(google.picker.Feature.NAV_HIDDEN)
          .setOAuthToken(accessToken)
          .addView(view)
          .setDeveloperKey(API_KEY)
          .setCallback(pickerCallback)
          .build();
      picker.setVisible(true);
    }

    async function pickerCallback(data) {
      if (data.action === google.picker.Action.PICKED) {
        const folderId = data.docs[0].id;
        const folderName = data.docs[0].name;
        await showImages(folderId);
      }
    }

    async function showImages(folderId) {
      await loadImageMetadata(folderId);      
      startSlideshow();
    }

    async function loadImageMetadata(folderId) {
      const response = await gapi.client.drive.files.list({
        q: `'${folderId}' in parents and trashed=false`,
        fields: 'files(id, name, mimeType)',
        orderBy: 'name',
        pageSize: 100
      });

      files = response.result.files.sort(() => Math.random() - .5);
    }

    async function startSlideshow(delay = 2000) {
      if (!files || files.length === 0) {
        const infoDiv = document.getElementById('info');
        infoDiv.innerHTML = '<p>No files found in this folder.</p>';
        return;
      }

      isSlideshowActive = true;
      showCurrentImage();

      slideshowTimer = setInterval(() => {
        if (currentIndex < files.length - 1) {
          currentIndex++;
        } else {
          currentIndex = 0;
        }

        showCurrentImage();
      }, delay);
    }

    function endSlideshow() {
      isSlideshowActive = false;

      if (slideshowTimer) {
        clearInterval(slideshowTimer);
        slideshowTimer = null;
      }

      const img = getImageTag();
      img.style.display = 'none';
    }

    async function showCurrentImage() {
      const img = getImageTag();
      const imageObjectUrl = await loadImage();

      if (!isSlideshowActive) return;

      img.src = imageObjectUrl
      img.style.display = 'block';
      img.onload = () => URL.revokeObjectURL(img.src);
    }

    function getImageTag() {
      let target = 'normal-image'
      if (fullscreen) { target = 'fullscreen-image' }
      return document.getElementById(target);
    }

    async function loadImage() {
      const file = files[currentIndex]

      const res = await fetch(`https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`, {
        headers: { Authorization: `Bearer ${accessToken}` }
      });
      const blob = await res.blob();

      return URL.createObjectURL(blob)
    }

    async function imageSizeToggle() {
      const overlay = document.getElementById('fullscreen-overlay');
  
      if (fullscreen) {
        // Exit fullscreen
        overlay.style.display = 'none';
        fullscreen = false
      } else {
        // Enter fullscreen
        overlay.style.display = 'flex';
        fullscreen = true
      }

      showCurrentImage()
    }

    // Set up event listeners
    document.getElementById('authorize-button').addEventListener('click', handleAuthClick);
    document.getElementById('signout-button').addEventListener('click', handleSignoutClick);
    document.getElementById('folder-picker-button').addEventListener('click', createPicker);
    document.getElementById('image-container').addEventListener('click', imageSizeToggle);
    document.getElementById('fullscreen-overlay').addEventListener('click', imageSizeToggle);  
  </script>
  
  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
  <script async defer src="https://apis.google.com/js/api.js?onload=gapiLoaded"></script>
</body>
</html>

